<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>CORE AFFINITY &vert; DOUGLAS SAYLES</title>
<meta name="description" content="">
<meta name="keywords" content="java, linux">



<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Core Affinity">
<meta property="og:description" content="">
<meta property="og:url" content="http://localhost:4000/linux,%20java/2016/12/21/core-affinity.html">
<meta property="og:site_name" content="Douglas Sayles">
<meta property="og:image" content="http://localhost:4000/images/">





<link rel="canonical" href="http://localhost:4000/linux,%20java/2016/12/21/core-affinity.html">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Douglas Sayles Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />


    <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700|Open+Sans:400,600,300,800,700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="http://localhost:4000/assets/css/vendor/font-awesome.min.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/vendor/normalize.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/vendor/nprogress.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/vendor/foundation.min.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/style.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/post.css">





<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">


</head>
<body class="post-template" itemscope itemtype="http://schema.org/WebPage">  

        <main id="notepad-post-container-simple" class="notepad-post-container-simple" role="main">
            <header class="notepad-post-header-simple">
                <div class="notepad-post-menu-header-simple">

                    <a class="notepad-blog-logo" href="http://localhost:4000">
                        <img src="http://localhost:4000/images/" alt="Blog Logo" />
                    </a>

                <div class="notepad-blog-menu">      
    <div class="notepad-mobile-menu show-for-small">
        <a href="#"><i class="fa fa-bars"></i></a>
    </div>
    <ul class="notepad-menu">
        <li class="notepad-mobile-close-btn show-for-small text-right">
            <a href="#"><i class="fa fa-times"></i></a>
        </li>
            
           <li><a href="http://localhost:4000/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a></li>
    </ul>

</div>
            </div>

                <div class="notepad-post-title-simple row">
                    <div class="small-12 columns">
                        <div class="notepad-post-meta-simple">

                            <h1>Core Affinity</h1>
                            <p>by <strong></strong> &#8212; on <a href="http://localhost:4000/tags/index.html#java, linux" data-toggle="tooltip" title="Posts tagged with java, linux" rel="tag">java, linux</a> <strong><time datetime="2016-12-21T07:25:00-07:00">21 Dec 2016</time></strong></p>
                        


<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- codein1 -->
<ins class="adsbygoogle"
     style="display:inline-block;width:728px;height:90px"
     data-ad-client="ca-pub-7466474470517357"
     data-ad-slot="6700962438"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>







</div>
                    </div>
                </div>
            </header>

        <article class="notepad-post-content post tag-simple">
            <div><p>Core affinity <em>or</em> Process affinity <em>always</em> playes a great roll for abtaining optimal latency if your application runs with limited threads.</p>

<p>Ideally application must keep limited threads and reuse it and many application does it unless immature programmer has done the coding, many multithreading applications frameworks also keeps the threadpool to reuse them, problem usually happpens when huge ammount of data comes in to the syatem and each threads have to do lot of work without being idle, lot of work brings lot of paging and context switching which is a costly operation, you can use <code class="highlighter-rouge">sar -w 5 5</code> to check your context swiching.</p>

<p>I’m working with java application which works in burst mode for some hours and  then works normal throughout a day, in that 1-2 hour  huge context switching happens which decrease  overall performance, i created small script which can divide threads evenly in all availabel cores and apply affinity to them so no context-switching happens which increases performance tremendously.</p>

<p>Below script takes pid of your java process and assigns core to each thread, there are lib which do the same from within java process but its way more hectic and i see  with shell its  waymore easy ;)</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

usage <span class="o">()</span>
<span class="o">{</span>
  <span class="nb">echo</span> <span class="s1">'Usage : affinity &lt;java_pid&gt;'</span>
  <span class="nb">exit</span>
<span class="o">}</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"$#"</span> -ne 1 <span class="o">]</span>
<span class="k">then
  </span>usage
<span class="k">fi


</span><span class="nv">_index</span><span class="o">=</span>0
<span class="nv">_cores</span><span class="o">=</span><span class="sb">`</span>nproc<span class="sb">`</span>


<span class="k">for </span>nid <span class="k">in</span> <span class="sb">`</span>jstack <span class="nv">$1</span> | grep nid  | cut -d<span class="s1">' '</span> -f6 | grep nid | cut -d<span class="s1">'='</span> -f2 | cut -d<span class="s1">'x'</span> -f2<span class="sb">`</span>
<span class="k">do 
	</span>taskset -p -c <span class="k">$((</span><span class="nv">$_index</span> <span class="o">%</span> <span class="nv">$_cores</span><span class="k">))</span> <span class="k">$((</span><span class="m">16</span><span class="c">#$nid)) </span>
	<span class="o">((</span>_index++<span class="k">))</span>
<span class="k">done</span>

</code></pre>
</div>

<p>source is here https://github.com/ameyjadiye/core-affinity , you can always provide improvements by pull req.</p>

<p>Happy Coding .. :)</p>

            </div>

<div style="text-align: center;">
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- codein2-footer -->
<ins class="adsbygoogle"
     style="display:inline-block;width:728px;height:90px"
     data-ad-client="ca-pub-7466474470517357"
     data-ad-slot="9952356430"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>





        </article>
        <div class="cf"></div>

        <div class="cf"></div>
        
            <div class="notepad-author-info">
                <div class="row">
                    <section class="notepad-post-author small-12 columns">
                        
                            <img src="http://localhost:4000/images/" class="notepad-post-author-avatar" alt="'s photo">
                        
                        
                            <span class="author-label">Author</span>
                            <h1></h1>
                        
                        
                            <p><a href="mailto:" class="author-website"></a>

			    <iframe src="//www.facebook.com/plugins/follow?href=https%3A%2F%2Fwww.facebook.com%2Fameyjadiye&amp;layout=standard&amp;show_faces=true&amp;colorscheme=light&amp;width=450&amp;height=80" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:450px; height:80px;" allowTransparency="true"></iframe> 
			    </p>
                        
                        
                            <p></p>
                        
                    </section>
                </div>
            </div>
 
        
        <div class="cf"></div>
        
        <div class="cf"></div>

    <footer class="notepad-site-footer">
    <div class="copyright">
        <section>All content copyright <a href="http://localhost:4000/about"></a> &copy; 2017 &bull; All rights reserved.</section>
	<p><a href='http://www.catb.org/hacker-emblem/' target="_blank"><img src='/assets/img/hacker.png' alt='hacker emblem' /></a>
          <a href="http://endsoftpatents.org/innovating-without-patents" target="_blank"><img style="border-width:0" src="/assets/img/patent-free.png"></a></p>
    </div>
    <div class="social-icons">
        
        
        
        
        
        
    </div>
    
    <div class="cf"></div>
</footer>
 
</main>    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.11.1.min.js"><\/script>')</script>
    <script src="http://localhost:4000/assets/js/vendor/modernizr.js"></script>
    <script src="http://localhost:4000/assets/js/foundation.min.js"></script>
    
    <script src="http://localhost:4000/assets/js/notepad.js"></script>
    <script src="http://localhost:4000/assets/js/scripts.min.js"></script>
    <script src="http://localhost:4000/assets/js/vendor/nprogress.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/sigma.js/1.0.3/sigma.min.js"></script>

    <script>
      $(document).foundation();
    </script>


<script>NProgress.start();var interval=setInterval(function(){NProgress.inc()},1000);jQuery(window).load(function(){clearInterval(interval);NProgress.done()});jQuery(window).unload(function(){NProgress.start()});</script>
 
</body>
</html>
